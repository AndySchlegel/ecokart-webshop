name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "destroy" to confirm deletion of ALL resources'
        required: true
        type: string
      delete_amplify_apps:
        description: 'Also delete Amplify apps?'
        required: true
        type: boolean
        default: true

env:
  AWS_REGION: eu-north-1
  TERRAFORM_VERSION: 1.5.0

permissions:
  id-token: write
  contents: read

jobs:
  destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest

    steps:
      - name: โ๏ธ Validate Destroy Confirmation
        run: |
          if [ "${{ inputs.confirm_destroy }}" != "destroy" ]; then
            echo "โ ERROR: You must type 'destroy' to confirm"
            echo "   You typed: '${{ inputs.confirm_destroy }}'"
            exit 1
          fi
          echo "โ Confirmation validated"

      - name: ๐ฅ Checkout Repository
        uses: actions/checkout@v4

      - name: ๐๏ธ Determine Environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
          fi

      - name: ๐ Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Destroy-${{ github.run_id }}

      - name: โ Verify AWS Authentication
        run: |
          echo "๐ Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "โ AWS authentication successful"

      - name: ๐ง Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: ๐ฆ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: ๐ Get GitHub Token from Parameter Store
        id: github-token
        run: |
          echo "๐ Fetching GitHub token from AWS Parameter Store..."
          TOKEN=$(aws ssm get-parameter \
            --name "/ecokart/github-token" \
            --with-decryption \
            --query 'Parameter.Value' \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "โ Token retrieved"

      - name: ๐ง Terraform Init
        working-directory: terraform
        run: |
          echo "๐ฆ Initializing Terraform..."
          terraform init -upgrade
          echo "โ Terraform initialized"

      - name: โ Verify Environment Config
        working-directory: terraform
        run: |
          CONFIG_FILE="environments/${{ steps.env.outputs.environment }}.tfvars"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "โ ERROR: Config file not found: $CONFIG_FILE"
            echo "Available configs:"
            ls -la environments/
            exit 1
          fi
          echo "โ Config file found: $CONFIG_FILE"

      - name: ๐ Terraform Plan Destroy (mit Environment-Config!)
        id: plan
        working-directory: terraform
        run: |
          echo "๐ Creating destruction plan for: ${{ steps.env.outputs.environment }}"
          echo "๐ Using config: environments/${{ steps.env.outputs.environment }}.tfvars"

          terraform plan -destroy \
            -var-file="environments/${{ steps.env.outputs.environment }}.tfvars" \
            -var="github_access_token=${{ steps.github-token.outputs.token }}" \
            -var="jwt_secret=dummy-secret-for-destroy-minimum-32-chars-required-padding" \
            -out=tfplan

          echo "โ Destruction plan created for ${{ steps.env.outputs.environment }}"

      - name: ๐๏ธ Delete Amplify Apps (Optional)
        if: inputs.delete_amplify_apps == true
        run: |
          echo "๐๏ธ Deleting all Amplify apps..."

          APP_IDS=$(aws amplify list-apps \
            --region ${{ env.AWS_REGION }} \
            --query 'apps[*].appId' \
            --output text)

          if [ -z "$APP_IDS" ]; then
            echo "   โน๏ธ  No Amplify apps found"
          else
            echo "   Found apps to delete:"
            for app_id in $APP_IDS; do
              APP_NAME=$(aws amplify get-app \
                --app-id "$app_id" \
                --region ${{ env.AWS_REGION }} \
                --query 'app.name' \
                --output text)

              echo "   - Deleting: $APP_NAME ($app_id)"

              aws amplify delete-app \
                --app-id "$app_id" \
                --region ${{ env.AWS_REGION }}
            done
            echo "   โ All Amplify apps deleted"
          fi

      - name: ๐ฅ Terraform Destroy
        working-directory: terraform
        run: |
          echo "๐ฅ Destroying infrastructure for: ${{ steps.env.outputs.environment }}"
          terraform apply -auto-approve tfplan
          echo "โ Infrastructure destroyed for ${{ steps.env.outputs.environment }}"

      # ======================================================================
      # Wait for AWS to process deletions
      # ======================================================================
      # AWS needs time to propagate deletions (eventual consistency)
      # Without this, cleanup steps might fail due to dependencies
      - name: โฐ Wait for AWS Deletion Propagation
        run: |
          echo "โฐ Waiting 60 seconds for AWS to process deletions..."
          echo "   (This prevents dependency conflicts during cleanup)"
          sleep 60
          echo "โ Wait complete"

      - name: ๐งน Cleanup Lambda Function (if still exists)
        run: |
          echo "๐งน Checking for remaining Lambda function for ${{ steps.env.outputs.environment }}..."

          LAMBDA_NAME="ecokart-${{ steps.env.outputs.environment }}-api"

          if aws lambda get-function \
            --function-name "$LAMBDA_NAME" \
            --region ${{ env.AWS_REGION }} &>/dev/null; then

            echo "   - Deleting Lambda function: $LAMBDA_NAME"
            aws lambda delete-function \
              --function-name "$LAMBDA_NAME" \
              --region ${{ env.AWS_REGION }}

            echo "   โ Lambda function deleted: $LAMBDA_NAME"
            echo "   โฐ Waiting 10 seconds for AWS to process..."
            sleep 10
          else
            echo "   โน๏ธ  Lambda function already deleted: $LAMBDA_NAME"
          fi

      - name: ๐งน Cleanup DynamoDB Tables (if still exist)
        run: |
          echo "๐งน Checking for remaining DynamoDB tables for ${{ steps.env.outputs.environment }}..."

          # Table names ohne Environment-Suffix (laut aktuellem Setup)
          TABLES=(
            "ecokart-products"
            "ecokart-users"
            "ecokart-carts"
            "ecokart-orders"
          )

          for table in "${TABLES[@]}"; do
            if aws dynamodb describe-table \
              --table-name "$table" \
              --region ${{ env.AWS_REGION }} &>/dev/null; then

              echo "   - Deleting remaining table: $table"
              aws dynamodb delete-table \
                --table-name "$table" \
                --region ${{ env.AWS_REGION }}

              # Wait for deletion
              echo "   - Waiting for $table to be deleted..."
              aws dynamodb wait table-not-exists \
                --table-name "$table" \
                --region ${{ env.AWS_REGION }}

              echo "   โ $table deleted"
            else
              echo "   โน๏ธ  $table already deleted"
            fi
          done
      - name: Delete Cognito User Pools
        run: |
          echo "๐๏ธ Deleting Cognito User Pools..."

          # Liste alle User Pools
          POOLS=$(aws cognito-idp list-user-pools --max-results 60 --region ${{ env.AWS_REGION }} --query "UserPools[?contains(Name, 'ecokart-${{ steps.env.outputs.environment }}')].Id" --output text)

          if [ -z "$POOLS" ]; then
            echo "   โน๏ธ  No Cognito User Pools found for ${{ steps.env.outputs.environment }}"
          else
            for POOL_ID in $POOLS; do
              echo "   - Deleting User Pool: $POOL_ID"
              aws cognito-idp delete-user-pool --user-pool-id "$POOL_ID" --region ${{ env.AWS_REGION }} || true
              echo "   โ User Pool deleted: $POOL_ID"
            done
            echo "โ All Cognito User Pools deleted"
          fi
        continue-on-error: true

      - name: ๐งน Cleanup API Gateways (if still exist)
        run: |
          echo "๐งน Checking for remaining API Gateways for ${{ steps.env.outputs.environment }}..."

          # Liste alle REST API Gateways mit "ecokart" im Namen
          API_IDS=$(aws apigateway get-rest-apis \
            --region ${{ env.AWS_REGION }} \
            --query "items[?contains(name, 'ecokart-${{ steps.env.outputs.environment }}')].id" \
            --output text)

          if [ -z "$API_IDS" ]; then
            echo "   โน๏ธ  No API Gateways found for ${{ steps.env.outputs.environment }}"
          else
            for api_id in $API_IDS; do
              API_NAME=$(aws apigateway get-rest-api \
                --rest-api-id "$api_id" \
                --region ${{ env.AWS_REGION }} \
                --query 'name' \
                --output text)

              echo "   - Deleting REST API Gateway: $API_NAME ($api_id)"

              aws apigateway delete-rest-api \
                --rest-api-id "$api_id" \
                --region ${{ env.AWS_REGION }} || true

              echo "   โ REST API Gateway deleted: $api_id"
            done
          fi
        continue-on-error: true

      - name: ๐งน Cleanup IAM Role (if still exists)
        run: |
          echo "๐งน Checking for remaining IAM role for ${{ steps.env.outputs.environment }}..."

          ROLE_NAME="ecokart-${{ steps.env.outputs.environment }}-api-exec-role"

          if aws iam get-role --role-name "$ROLE_NAME" &>/dev/null; then
            echo "   - Detaching managed policies..."
            aws iam detach-role-policy \
              --role-name "$ROLE_NAME" \
              --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole \
              2>/dev/null || true

            echo "   - Deleting inline policies..."
            aws iam delete-role-policy \
              --role-name "$ROLE_NAME" \
              --policy-name ecokart-${{ steps.env.outputs.environment }}-api-dynamodb-policy \
              2>/dev/null || true

            echo "   - Deleting role..."
            aws iam delete-role --role-name "$ROLE_NAME"

            echo "   โ IAM role deleted: $ROLE_NAME"
          else
            echo "   โน๏ธ  IAM role already deleted: $ROLE_NAME"
          fi

      - name: ๐งน Cleanup CloudWatch Log Group (if still exists)
        run: |
          echo "๐งน Checking for remaining CloudWatch log group for ${{ steps.env.outputs.environment }}..."

          LOG_GROUP="/aws/lambda/ecokart-${{ steps.env.outputs.environment }}-api"

          if aws logs describe-log-groups \
            --log-group-name-prefix "$LOG_GROUP" \
            --region ${{ env.AWS_REGION }} \
            --query 'logGroups[0].logGroupName' \
            --output text 2>/dev/null | grep -q "$LOG_GROUP"; then

            echo "   - Deleting log group: $LOG_GROUP"
            aws logs delete-log-group \
              --log-group-name "$LOG_GROUP" \
              --region ${{ env.AWS_REGION }}

            echo "   โ Log group deleted: $LOG_GROUP"
          else
            echo "   โน๏ธ  Log group already deleted: $LOG_GROUP"
          fi

      - name: ๐ Destruction Summary
        if: always()
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ                    ๐๏ธ  DESTRUCTION COMPLETE                       โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "Environment: ${{ steps.env.outputs.environment }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Destroyed at: $(date -u)"
          echo ""
          echo "๐๏ธ  Deleted Resources:"
          echo "   - Lambda Function (auto-cleanup)"
          echo "   - DynamoDB Tables (4)"
          echo "   - API Gateways (all ecokart-${{ steps.env.outputs.environment }})"
          echo "   - Cognito User Pools (all ecokart-development)"
          if [ "${{ inputs.delete_amplify_apps }}" == "true" ]; then
            echo "   - Amplify Apps (all)"
          fi
          echo "   - CloudWatch Log Groups"
          echo "   - IAM Roles & Policies"
          echo ""
          echo "โ All resources have been destroyed!"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ  To redeploy, run the 'Deploy Infrastructure' workflow           โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
