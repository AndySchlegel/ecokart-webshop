name: Nuclear Cleanup - Delete Everything

on:
  workflow_dispatch:
    inputs:
      confirm_nuclear:
        description: 'Type "NUCLEAR" to confirm complete deletion'
        required: true
        type: string
      environment:
        description: 'Environment to clean'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'development'

env:
  AWS_REGION: eu-central-1

permissions:
  id-token: write
  contents: read

jobs:
  nuclear-cleanup:
    name: Nuclear Cleanup
    runs-on: ubuntu-latest

    steps:
      - name: âš ï¸ Validate Nuclear Confirmation
        run: |
          if [ "${{ inputs.confirm_nuclear }}" != "NUCLEAR" ]; then
            echo "âŒ ERROR: You must type 'NUCLEAR' to confirm"
            echo "   You typed: '${{ inputs.confirm_nuclear }}'"
            exit 1
          fi
          echo "âœ… Nuclear cleanup confirmed"
          echo "âš ï¸  This will delete EVERYTHING without using Terraform"

      - name: ğŸ” Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-NuclearCleanup-${{ github.run_id }}

      - name: âœ… Verify AWS Authentication
        run: |
          echo "ğŸ” Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "âœ… AWS authentication successful"

      - name: ğŸ—‘ï¸ Delete Amplify Apps
        run: |
          echo "ğŸ—‘ï¸ Deleting all Amplify apps..."

          APP_IDS=$(aws amplify list-apps \
            --region ${{ env.AWS_REGION }} \
            --query 'apps[*].appId' \
            --output text)

          if [ -z "$APP_IDS" ]; then
            echo "   â„¹ï¸  No Amplify apps found"
          else
            echo "   Found apps to delete:"
            for app_id in $APP_IDS; do
              APP_NAME=$(aws amplify get-app \
                --app-id "$app_id" \
                --region ${{ env.AWS_REGION }} \
                --query 'app.name' \
                --output text)

              echo "   - Deleting: $APP_NAME ($app_id)"

              aws amplify delete-app \
                --app-id "$app_id" \
                --region ${{ env.AWS_REGION }} || true
            done
            echo "   âœ… All Amplify apps deleted"
          fi
        continue-on-error: true

      - name: â° Wait for AWS Deletion Propagation
        run: |
          echo "â° Waiting 30 seconds for AWS to process Amplify deletions..."
          sleep 30
          echo "âœ… Wait complete"

      - name: ğŸ—‘ï¸ Delete Amplify IAM Service Roles
        run: |
          echo "ğŸ—‘ï¸ Deleting Amplify IAM Service Roles for ${{ inputs.environment }}..."

          ROLES=(
            "ecokart-${{ inputs.environment }}-frontend-amplify-role"
            "ecokart-${{ inputs.environment }}-admin-frontend-amplify-role"
          )

          for ROLE_NAME in "${ROLES[@]}"; do
            if aws iam get-role --role-name "$ROLE_NAME" &>/dev/null; then
              echo "   - Found role: $ROLE_NAME"

              # Detach managed policies
              echo "     - Detaching managed policies..."
              MANAGED_POLICIES=$(aws iam list-attached-role-policies \
                --role-name "$ROLE_NAME" \
                --query 'AttachedPolicies[*].PolicyArn' \
                --output text)

              for policy_arn in $MANAGED_POLICIES; do
                echo "       - Detaching: $policy_arn"
                aws iam detach-role-policy \
                  --role-name "$ROLE_NAME" \
                  --policy-arn "$policy_arn" || true
              done

              # Delete inline policies
              echo "     - Deleting inline policies..."
              INLINE_POLICIES=$(aws iam list-role-policies \
                --role-name "$ROLE_NAME" \
                --query 'PolicyNames' \
                --output text)

              for policy_name in $INLINE_POLICIES; do
                echo "       - Deleting: $policy_name"
                aws iam delete-role-policy \
                  --role-name "$ROLE_NAME" \
                  --policy-name "$policy_name" || true
              done

              # Delete role
              echo "     - Deleting role..."
              aws iam delete-role --role-name "$ROLE_NAME"
              echo "   âœ… IAM role deleted: $ROLE_NAME"
            else
              echo "   â„¹ï¸  IAM role already deleted: $ROLE_NAME"
            fi
          done
        continue-on-error: true

      - name: ğŸ—‘ï¸ Delete Lambda Functions
        run: |
          echo "ğŸ—‘ï¸ Deleting Lambda functions for ${{ inputs.environment }}..."

          LAMBDA_NAME="ecokart-${{ inputs.environment }}-api"

          if aws lambda get-function \
            --function-name "$LAMBDA_NAME" \
            --region ${{ env.AWS_REGION }} &>/dev/null; then

            echo "   - Deleting Lambda function: $LAMBDA_NAME"
            aws lambda delete-function \
              --function-name "$LAMBDA_NAME" \
              --region ${{ env.AWS_REGION }}

            echo "   âœ… Lambda function deleted: $LAMBDA_NAME"
          else
            echo "   â„¹ï¸  Lambda function already deleted: $LAMBDA_NAME"
          fi
        continue-on-error: true

      - name: ğŸ—‘ï¸ Delete API Gateway Custom Domains
        run: |
          echo "ğŸ—‘ï¸ Deleting API Gateway Custom Domains..."

          # Liste alle Custom Domains fÃ¼r his4irness23.de
          DOMAINS=$(aws apigateway get-domain-names \
            --region ${{ env.AWS_REGION }} \
            --query "items[?contains(domainName, 'his4irness23.de')].domainName" \
            --output text)

          if [ -z "$DOMAINS" ]; then
            echo "   â„¹ï¸  No API Gateway Custom Domains found"
          else
            for domain in $DOMAINS; do
              echo "   - Deleting Custom Domain: $domain"

              # Hole Base Path Mappings und lÃ¶sche sie zuerst
              echo "     - Checking for Base Path Mappings..."
              BASE_PATHS=$(aws apigateway get-base-path-mappings \
                --domain-name "$domain" \
                --region ${{ env.AWS_REGION }} \
                --query 'items[*].basePath' \
                --output text 2>/dev/null || echo "")

              if [ -n "$BASE_PATHS" ]; then
                for base_path in $BASE_PATHS; do
                  # Empty string fÃ¼r root path wird als "(none)" angezeigt
                  if [ "$base_path" = "(none)" ]; then
                    base_path=""
                  fi
                  echo "       - Deleting Base Path Mapping: ${base_path:-'/'}"
                  aws apigateway delete-base-path-mapping \
                    --domain-name "$domain" \
                    --base-path "$base_path" \
                    --region ${{ env.AWS_REGION }} || true
                done
              fi

              # LÃ¶sche Custom Domain
              echo "     - Deleting Domain..."
              aws apigateway delete-domain-name \
                --domain-name "$domain" \
                --region ${{ env.AWS_REGION }} || true

              echo "   âœ… Custom Domain deleted: $domain"
            done
          fi
        continue-on-error: true

      - name: ğŸ—‘ï¸ Delete API Gateways (REST APIs)
        run: |
          echo "ğŸ—‘ï¸ Deleting REST API Gateways for ${{ inputs.environment }}..."

          # Liste alle REST API Gateways
          API_IDS=$(aws apigateway get-rest-apis \
            --region ${{ env.AWS_REGION }} \
            --query "items[?contains(name, 'ecokart-${{ inputs.environment }}')].id" \
            --output text)

          if [ -z "$API_IDS" ]; then
            echo "   â„¹ï¸  No REST API Gateways found"
          else
            for api_id in $API_IDS; do
              API_NAME=$(aws apigateway get-rest-api \
                --rest-api-id "$api_id" \
                --region ${{ env.AWS_REGION }} \
                --query 'name' \
                --output text)

              echo "   - Deleting REST API Gateway: $API_NAME ($api_id)"

              aws apigateway delete-rest-api \
                --rest-api-id "$api_id" \
                --region ${{ env.AWS_REGION }} || true

              echo "   âœ… REST API Gateway deleted: $api_id"
            done
          fi
        continue-on-error: true

      - name: ğŸ—‘ï¸ Delete Cognito User Pools
        run: |
          echo "ğŸ—‘ï¸ Deleting Cognito User Pools for ${{ inputs.environment }}..."

          POOLS=$(aws cognito-idp list-user-pools \
            --max-results 60 \
            --region ${{ env.AWS_REGION }} \
            --query "UserPools[?contains(Name, 'ecokart-${{ inputs.environment }}')].Id" \
            --output text)

          if [ -z "$POOLS" ]; then
            echo "   â„¹ï¸  No Cognito User Pools found"
          else
            for POOL_ID in $POOLS; do
              echo "   - Deleting User Pool: $POOL_ID"
              aws cognito-idp delete-user-pool \
                --user-pool-id "$POOL_ID" \
                --region ${{ env.AWS_REGION }} || true
              echo "   âœ… User Pool deleted: $POOL_ID"
            done
          fi
        continue-on-error: true

      - name: ğŸ—‘ï¸ Delete DynamoDB Tables
        run: |
          echo "ğŸ—‘ï¸ Deleting DynamoDB tables..."

          TABLES=(
            "ecokart-products"
            "ecokart-users"
            "ecokart-carts"
            "ecokart-orders"
          )

          for table in "${TABLES[@]}"; do
            if aws dynamodb describe-table \
              --table-name "$table" \
              --region ${{ env.AWS_REGION }} &>/dev/null; then

              echo "   - Deleting table: $table"
              aws dynamodb delete-table \
                --table-name "$table" \
                --region ${{ env.AWS_REGION }}

              echo "   - Waiting for $table to be deleted..."
              aws dynamodb wait table-not-exists \
                --table-name "$table" \
                --region ${{ env.AWS_REGION }} || true

              echo "   âœ… $table deleted"
            else
              echo "   â„¹ï¸  $table already deleted"
            fi
          done
        continue-on-error: true

      - name: ğŸ—‘ï¸ Delete IAM Role
        run: |
          echo "ğŸ—‘ï¸ Deleting IAM role for ${{ inputs.environment }}..."

          ROLE_NAME="ecokart-${{ inputs.environment }}-api-exec-role"

          if aws iam get-role --role-name "$ROLE_NAME" &>/dev/null; then
            echo "   - Detaching managed policies..."
            aws iam detach-role-policy \
              --role-name "$ROLE_NAME" \
              --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole \
              2>/dev/null || true

            echo "   - Deleting inline policies..."
            INLINE_POLICIES=$(aws iam list-role-policies \
              --role-name "$ROLE_NAME" \
              --query 'PolicyNames' \
              --output text)

            for policy in $INLINE_POLICIES; do
              echo "     - Deleting policy: $policy"
              aws iam delete-role-policy \
                --role-name "$ROLE_NAME" \
                --policy-name "$policy" || true
            done

            echo "   - Deleting role..."
            aws iam delete-role --role-name "$ROLE_NAME"

            echo "   âœ… IAM role deleted: $ROLE_NAME"
          else
            echo "   â„¹ï¸  IAM role already deleted: $ROLE_NAME"
          fi
        continue-on-error: true

      - name: ğŸ—‘ï¸ Delete CloudWatch Log Groups
        run: |
          echo "ğŸ—‘ï¸ Deleting CloudWatch log groups for ${{ inputs.environment }}..."

          LOG_GROUP="/aws/lambda/ecokart-${{ inputs.environment }}-api"

          if aws logs describe-log-groups \
            --log-group-name-prefix "$LOG_GROUP" \
            --region ${{ env.AWS_REGION }} \
            --query 'logGroups[0].logGroupName' \
            --output text 2>/dev/null | grep -q "$LOG_GROUP"; then

            echo "   - Deleting log group: $LOG_GROUP"
            aws logs delete-log-group \
              --log-group-name "$LOG_GROUP" \
              --region ${{ env.AWS_REGION }}

            echo "   âœ… Log group deleted: $LOG_GROUP"
          else
            echo "   â„¹ï¸  Log group already deleted: $LOG_GROUP"
          fi
        continue-on-error: true

      - name: ğŸ—‘ï¸ Delete CloudWatch Metric Alarms
        run: |
          echo "ğŸ—‘ï¸ Deleting CloudWatch Metric Alarms for ${{ inputs.environment }}..."

          # Liste alle Alarms die mit "ecokart-" beginnen
          ALARMS=$(aws cloudwatch describe-alarms \
            --region ${{ env.AWS_REGION }} \
            --query "MetricAlarms[?starts_with(AlarmName, 'ecokart-')].AlarmName" \
            --output text)

          if [ -z "$ALARMS" ]; then
            echo "   â„¹ï¸  No CloudWatch Metric Alarms found"
          else
            echo "   Found alarms to delete:"
            for alarm in $ALARMS; do
              echo "   - Deleting alarm: $alarm"
              aws cloudwatch delete-alarms \
                --alarm-names "$alarm" \
                --region ${{ env.AWS_REGION }} || true
            done
            echo "   âœ… All CloudWatch Metric Alarms deleted"
          fi
        continue-on-error: true

      - name: ğŸ—‘ï¸ Delete Terraform State from S3
        run: |
          echo "ğŸ—‘ï¸ Deleting Terraform state files..."

          BUCKET_NAME="ecokart-terraform-state-805160323349"
          STATE_KEYS=(
            "development/terraform.tfstate"
            "personal-development/terraform.tfstate"
          )

          for STATE_KEY in "${STATE_KEYS[@]}"; do
            if aws s3api head-object \
              --bucket "$BUCKET_NAME" \
              --key "$STATE_KEY" \
              --region ${{ env.AWS_REGION }} &>/dev/null; then

              echo "   - Deleting state file: s3://$BUCKET_NAME/$STATE_KEY"
              aws s3 rm "s3://$BUCKET_NAME/$STATE_KEY" --region ${{ env.AWS_REGION }}

              echo "   âœ… State file deleted: $STATE_KEY"
            else
              echo "   â„¹ï¸  State file already deleted or doesn't exist: $STATE_KEY"
            fi
          done
        continue-on-error: true

      - name: ğŸ—‘ï¸ Delete DynamoDB State Lock Entries
        run: |
          echo "ğŸ—‘ï¸ Deleting DynamoDB state lock entries..."

          # Scan for all lock entries (MD5 digests) in the lock table
          LOCK_IDS=$(aws dynamodb scan \
            --table-name terraform-state-lock \
            --region ${{ env.AWS_REGION }} \
            --query 'Items[*].LockID.S' \
            --output text)

          if [ -z "$LOCK_IDS" ]; then
            echo "   â„¹ï¸  No DynamoDB lock entries found"
          else
            echo "   Found lock entries to delete:"
            for LOCK_ID in $LOCK_IDS; do
              echo "   - Deleting lock entry: $LOCK_ID"
              aws dynamodb delete-item \
                --table-name terraform-state-lock \
                --key "{\"LockID\": {\"S\": \"$LOCK_ID\"}}" \
                --region ${{ env.AWS_REGION }} || true
            done
            echo "   âœ… All DynamoDB lock entries deleted"
          fi
        continue-on-error: true

      - name: ğŸ—‘ï¸ Delete SSM Parameters
        run: |
          echo "ğŸ—‘ï¸ Deleting SSM Parameters for ${{ inputs.environment }}..."

          PARAMS=(
            "/ecokart/${{ inputs.environment }}/frontend-url"
            "/ecokart/develop/frontend-url"
            "/ecokart/staging/frontend-url"
            "/ecokart/production/frontend-url"
          )

          for PARAM_NAME in "${PARAMS[@]}"; do
            if aws ssm get-parameter \
              --name "$PARAM_NAME" \
              --region ${{ env.AWS_REGION }} &>/dev/null; then

              echo "   - Deleting parameter: $PARAM_NAME"
              aws ssm delete-parameter \
                --name "$PARAM_NAME" \
                --region ${{ env.AWS_REGION }}

              echo "   âœ… Parameter deleted: $PARAM_NAME"
            else
              echo "   â„¹ï¸  Parameter already deleted: $PARAM_NAME"
            fi
          done
        continue-on-error: true

      - name: ğŸ“Š Cleanup Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    ğŸ’¥ NUCLEAR CLEANUP COMPLETE                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Environment: ${{ inputs.environment }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Cleaned at: $(date -u)"
          echo ""
          echo "ğŸ—‘ï¸  Deleted Resources (via AWS CLI):"
          echo "   - âœ… Amplify Apps (all)"
          echo "   - âœ… Lambda Functions"
          echo "   - âœ… API Gateways"
          echo "   - âœ… Cognito User Pools"
          echo "   - âœ… DynamoDB Tables (4)"
          echo "   - âœ… IAM Roles & Policies"
          echo "   - âœ… CloudWatch Log Groups"
          echo "   - âœ… CloudWatch Metric Alarms"
          echo "   - âœ… DynamoDB State Lock Entries"
          echo "   - âœ… SSM Parameters"
          echo "   - âœ… Terraform State Files"
          echo ""
          echo "âœ… Environment is now completely clean!"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  Ready for fresh deployment via 'Deploy Infrastructure' workflow â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
