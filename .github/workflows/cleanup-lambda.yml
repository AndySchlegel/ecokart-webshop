name: Emergency Lambda Cleanup

on:
  workflow_dispatch:
    inputs:
      lambda_name:
        description: 'Lambda function name to delete'
        required: true
        type: string
        default: 'ecokart-development-api'

env:
  AWS_REGION: eu-central-1

permissions:
  id-token: write
  contents: read

jobs:
  cleanup:
    name: Delete Lambda Function
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ” Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Cleanup-${{ github.run_id }}

      - name: ðŸ—‘ï¸ Delete Lambda Function
        run: |
          LAMBDA_NAME="${{ inputs.lambda_name }}"
          echo "ðŸ” Checking Lambda: $LAMBDA_NAME"

          if aws lambda get-function --function-name "$LAMBDA_NAME" --region ${{ env.AWS_REGION }} &>/dev/null; then
            echo "â— Lambda found! Deleting..."

            aws lambda delete-function \
              --function-name "$LAMBDA_NAME" \
              --region ${{ env.AWS_REGION }}

            echo "âœ… Lambda deleted: $LAMBDA_NAME"
            echo "â° Waiting 30 seconds..."
            sleep 30
            echo "âœ… Done!"
          else
            echo "â„¹ï¸  Lambda not found (already deleted or never existed)"
          fi

      - name: ðŸ“Š Summary
        run: |
          echo "# ðŸ§¹ Lambda Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Lambda:** ${{ inputs.lambda_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… You can now deploy again!" >> $GITHUB_STEP_SUMMARY
